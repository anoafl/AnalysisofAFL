---
title : "But We Won Everywhere but the Scoreboard"
description : "Introduction to logistic regression"
author : "Robert Nguyen"
date : 2018-06-23
tags : ["regression", "fitzRoy","modelling"]

---



<p>Something that gets to many a footy fan, is the feeling that your team has won the game in most areas expect on the scoreboard.</p>
<p>Thinking about this statement a little bit deeper has the following implication. That there are some areas of the game, that if you win, you tend to win the game.</p>
<p>We can think about this by putting it into a model.</p>
<p>The model I will use here, is a logistic regression model with the binary outcome being win/loss.</p>
<p>The data we will use here is the game differentials of the various game statistics that are available using <a href="https://github.com/jimmyday12/fitzRoy">fitzRoy</a></p>
<div id="step-one" class="section level1">
<h1>Step One</h1>
<p>Create the dataset we will use for modelling.</p>
<p>The general idea is its fairly obvious if you score more than the opposition you win. Shocking I know! What we are trying to do here, is come up with a concept of we won other things but not the scoreboard, usually when we win these things we tend to win a game.</p>
<pre class="r"><code>library(tidyverse)</code></pre>
<pre><code>## -- Attaching packages --------------------------------------------------- tidyverse 1.2.1 --</code></pre>
<pre><code>## v ggplot2 2.2.1     v purrr   0.2.5
## v tibble  1.4.2     v dplyr   0.7.5
## v tidyr   0.8.1     v stringr 1.3.1
## v readr   1.1.1     v forcats 0.3.0</code></pre>
<pre><code>## -- Conflicts ------------------------------------------------------ tidyverse_conflicts() --
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()</code></pre>
<pre class="r"><code>fitzRoy::player_stats%&gt;%
    filter(Season&gt;2014 &amp; Season&lt;2018)%&gt;%
    select(-Player)%&gt;%
    group_by(Date,Season, Round, Team, Status, Opposition, Venue, Match_id)%&gt;%
    summarise_all(.funs = sum)%&gt;%
group_by(Match_id)%&gt;%
  arrange(Match_id)%&gt;%
  mutate(diff_cp=c(-diff(CP), diff(CP)))</code></pre>
<pre><code>## # A tibble: 1,240 x 43
## # Groups:   Match_id [620]
##    Date       Season Round  Team    Status Opposition Venue Match_id    CP
##    &lt;date&gt;      &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;      &lt;chr&gt;    &lt;dbl&gt; &lt;int&gt;
##  1 2015-04-02   2015 Round~ Carlton Home   Richmond   MCG       5964   127
##  2 2015-04-02   2015 Round~ Richmo~ Away   Carlton    MCG       5964   121
##  3 2015-04-04   2015 Round~ Gold C~ Away   Melbourne  MCG       5965   136
##  4 2015-04-04   2015 Round~ Melbou~ Home   Gold Coast MCG       5965   150
##  5 2015-04-04   2015 Round~ Essend~ Away   Sydney     ANZ ~     5966   150
##  6 2015-04-04   2015 Round~ Sydney  Home   Essendon   ANZ ~     5966   176
##  7 2015-04-04   2015 Round~ Brisba~ Home   Collingwo~ Gabba     5967   152
##  8 2015-04-04   2015 Round~ Collin~ Away   Brisbane   Gabba     5967   165
##  9 2015-04-04   2015 Round~ West C~ Away   Western B~ Etih~     5968   137
## 10 2015-04-04   2015 Round~ Wester~ Home   West Coast Etih~     5968   156
## # ... with 1,230 more rows, and 34 more variables: UP &lt;int&gt;, ED &lt;int&gt;,
## #   DE &lt;dbl&gt;, CM &lt;int&gt;, GA &lt;int&gt;, MI5 &lt;int&gt;, One.Percenters &lt;int&gt;,
## #   BO &lt;int&gt;, TOG &lt;int&gt;, K &lt;int&gt;, HB &lt;int&gt;, D &lt;int&gt;, M &lt;int&gt;, G &lt;int&gt;,
## #   B &lt;int&gt;, T &lt;int&gt;, HO &lt;int&gt;, GA1 &lt;int&gt;, I50 &lt;int&gt;, CL &lt;int&gt;, CG &lt;int&gt;,
## #   R50 &lt;int&gt;, FF &lt;int&gt;, FA &lt;int&gt;, AF &lt;int&gt;, SC &lt;int&gt;, CCL &lt;int&gt;,
## #   SCL &lt;int&gt;, SI &lt;int&gt;, MG &lt;int&gt;, TO &lt;int&gt;, ITC &lt;int&gt;, T5 &lt;int&gt;,
## #   diff_cp &lt;int&gt;</code></pre>
<pre class="r"><code>fitzRoy::player_stats%&gt;%
         filter(Season&gt;2014 &amp; Season&lt;2018)%&gt;%
         select(-Player,-Date)%&gt;%
         group_by(Season, Round, Team, Status, Opposition, Venue, Match_id)%&gt;%
         summarise_all(.funs = sum)%&gt;%
         group_by(Match_id)%&gt;%
         arrange(Match_id)%&gt;%
         mutate_if(is.numeric, funs(difference=c(-diff(.), diff(.))))</code></pre>
<pre><code>## # A tibble: 1,240 x 76
## # Groups:   Match_id [620]
##    Season Round  Team   Status Opposition Venue Match_id    CP    UP    ED
##     &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;      &lt;chr&gt;    &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
##  1   2015 Round~ Carlt~ Home   Richmond   MCG       5964   127   199   233
##  2   2015 Round~ Richm~ Away   Carlton    MCG       5964   121   227   273
##  3   2015 Round~ Gold ~ Away   Melbourne  MCG       5965   136   165   203
##  4   2015 Round~ Melbo~ Home   Gold Coast MCG       5965   150   198   246
##  5   2015 Round~ Essen~ Away   Sydney     ANZ ~     5966   150   171   226
##  6   2015 Round~ Sydney Home   Essendon   ANZ ~     5966   176   192   248
##  7   2015 Round~ Brisb~ Home   Collingwo~ Gabba     5967   152   211   246
##  8   2015 Round~ Colli~ Away   Brisbane   Gabba     5967   165   179   231
##  9   2015 Round~ West ~ Away   Western B~ Etih~     5968   137   236   278
## 10   2015 Round~ Weste~ Home   West Coast Etih~     5968   156   214   275
## # ... with 1,230 more rows, and 66 more variables: DE &lt;dbl&gt;, CM &lt;int&gt;,
## #   GA &lt;int&gt;, MI5 &lt;int&gt;, One.Percenters &lt;int&gt;, BO &lt;int&gt;, TOG &lt;int&gt;,
## #   K &lt;int&gt;, HB &lt;int&gt;, D &lt;int&gt;, M &lt;int&gt;, G &lt;int&gt;, B &lt;int&gt;, T &lt;int&gt;,
## #   HO &lt;int&gt;, GA1 &lt;int&gt;, I50 &lt;int&gt;, CL &lt;int&gt;, CG &lt;int&gt;, R50 &lt;int&gt;,
## #   FF &lt;int&gt;, FA &lt;int&gt;, AF &lt;int&gt;, SC &lt;int&gt;, CCL &lt;int&gt;, SCL &lt;int&gt;,
## #   SI &lt;int&gt;, MG &lt;int&gt;, TO &lt;int&gt;, ITC &lt;int&gt;, T5 &lt;int&gt;,
## #   Season_difference &lt;dbl&gt;, CP_difference &lt;int&gt;, UP_difference &lt;int&gt;,
## #   ED_difference &lt;int&gt;, DE_difference &lt;dbl&gt;, CM_difference &lt;int&gt;,
## #   GA_difference &lt;int&gt;, MI5_difference &lt;int&gt;,
## #   One.Percenters_difference &lt;int&gt;, BO_difference &lt;int&gt;,
## #   TOG_difference &lt;int&gt;, K_difference &lt;int&gt;, HB_difference &lt;int&gt;,
## #   D_difference &lt;int&gt;, M_difference &lt;int&gt;, G_difference &lt;int&gt;,
## #   B_difference &lt;int&gt;, T_difference &lt;int&gt;, HO_difference &lt;int&gt;,
## #   GA1_difference &lt;int&gt;, I50_difference &lt;int&gt;, CL_difference &lt;int&gt;,
## #   CG_difference &lt;int&gt;, R50_difference &lt;int&gt;, FF_difference &lt;int&gt;,
## #   FA_difference &lt;int&gt;, AF_difference &lt;int&gt;, SC_difference &lt;int&gt;,
## #   CCL_difference &lt;int&gt;, SCL_difference &lt;int&gt;, SI_difference &lt;int&gt;,
## #   MG_difference &lt;int&gt;, TO_difference &lt;int&gt;, ITC_difference &lt;int&gt;,
## #   T5_difference &lt;int&gt;</code></pre>
<pre class="r"><code>df&lt;-fitzRoy::player_stats%&gt;%
         filter(Season&gt;2014)%&gt;%
         select(-Player)%&gt;%
         group_by(Date,Season, Round, Team, Status, Opposition, Venue, Match_id)%&gt;%
         summarise_all(.funs = sum)%&gt;%
         group_by(Match_id)%&gt;%
         arrange(Match_id)%&gt;%
         mutate_if(is.numeric, funs(difference=c(-diff(.), diff(.))))

df2&lt;-fitzRoy::match_results
df2&lt;-df2%&gt;%filter(Season&gt;2014)
df3&lt;-select(df2, Date, Round, Home.Team, Home.Points)
df4&lt;-select(df2, Date, Round, Away.Team, Away.Points)
colnames(df3)[3]&lt;-&quot;Team&quot;
colnames(df3)[4]&lt;-&quot;Points&quot;
colnames(df4)[3]&lt;-&quot;Team&quot;
colnames(df4)[4]&lt;-&quot;Points&quot;


df5&lt;-rbind(df4,df3)



df5&lt;-df5 %&gt;%mutate(Team = str_replace(Team, &quot;Brisbane Lions&quot;, &quot;Brisbane&quot;))

df5&lt;-df5 %&gt;%mutate(Team = str_replace(Team, &quot;Footscray&quot;, &quot;Western Bulldogs&quot;))


df6&lt;-inner_join(df,df5, by=c(&quot;Team&quot;,&quot;Date&quot;))

dataset_columns &lt;- c(1,2,4,6,7,8,44:80,81)
dataset&lt;-df6%&gt;%group_by(Match_id)%&gt;%
  arrange(Match_id)%&gt;%
  mutate(Margin=c(-diff(Points), diff(Points)))%&gt;%
  mutate(Win_loss=if_else(Margin&gt;0,1,0,NULL))%&gt;%
  select(dataset_columns)</code></pre>
<pre class="r"><code>library(aod)
library(ordinal)</code></pre>
<pre><code>## 
## Attaching package: &#39;ordinal&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:dplyr&#39;:
## 
##     slice</code></pre>
<pre class="r"><code>library(lme4)</code></pre>
<pre><code>## Loading required package: Matrix</code></pre>
<pre><code>## 
## Attaching package: &#39;Matrix&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:tidyr&#39;:
## 
##     expand</code></pre>
<pre><code>## 
## Attaching package: &#39;lme4&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:ordinal&#39;:
## 
##     ranef, VarCorr</code></pre>
<pre class="r"><code>in.sample  &lt;- subset(dataset, Season %in% c(2015:2017))
#in.sample  &lt;- subset(mydata, year ==2008)
out.sample &lt;- subset(dataset, Season == 2018)

in.sample$Win_loss &lt;- factor(in.sample$Win_loss)

out.sample$Win_loss&lt;-factor(out.sample$Win_loss)


temp1&lt;-scale(in.sample[,7:40])
in.sample[,7:40]&lt;-temp1
#attributes(temp1)
temp1.center&lt;-attr(temp1,&quot;scaled:center&quot;)
temp1.scale&lt;-attr(temp1,&quot;scaled:scale&quot;)

m &lt;- glm(Win_loss ~CP_difference+UP_difference+CM_difference+T_difference, 
         data = in.sample, family =binomial)



newdata   &lt;- out.sample[ , -ncol(out.sample)]


newdata[,7:40]&lt;-scale(newdata[,7:40],center=temp1.center,scale=temp1.scale) 



pre.dict    &lt;- predict(m,newdata=newdata, type=&quot;response&quot;)
pre.dict.m  &lt;- data.frame(matrix(unlist(pre.dict), nrow= nrow(newdata)))
colnames(pre.dict.m) &lt;- c(&quot;prob.win&quot;)

newdata.pred  &lt;- cbind.data.frame(newdata, pre.dict.m)
newdata.pred%&gt;%
  filter(Margin&lt;0)%&gt;%
  arrange(desc(prob.win))%&gt;%
  top_n(10)</code></pre>
<pre><code>## Selecting by prob.win</code></pre>
<pre><code>##          Date Season             Team Opposition          Venue Match_id
## 1  2018-04-08   2018          Geelong West Coast  Optus Stadium     9540
## 2  2018-06-02   2018         St Kilda West Coast  Optus Stadium     9608
## 3  2018-04-14   2018 Western Bulldogs     Sydney Etihad Stadium     9544
## 4  2018-05-26   2018         St Kilda   Richmond            MCG     9596
## 5  2018-03-31   2018      Collingwood        GWS            MCG     9526
## 6  2018-04-07   2018              GWS     Sydney            SCG     9536
## 7  2018-05-13   2018      Collingwood    Geelong            MCG     9585
## 8  2018-04-24   2018        Melbourne   Richmond            MCG     9557
## 9  2018-05-05   2018         Essendon   Hawthorn            MCG     9570
## 10 2018-04-02   2018          Geelong   Hawthorn            MCG     9531
##    CP_difference UP_difference ED_difference DE_difference CM_difference
## 1     0.21206978     0.6604902     0.4908878   -0.25506727     1.3445332
## 2     0.10603489     1.3209804     0.8765853    0.30509969    -1.0083999
## 3     0.10603489     1.0945266     0.6311414   -0.05591859    -0.5041999
## 4    -0.15905234     1.5096919     1.3674731    2.24459196    -1.3445332
## 5     0.21206978     0.3396807     0.2980390   -0.73871405     0.5041999
## 6     0.05301745     0.0377423    -0.2103805   -0.60137014     0.0000000
## 7    -0.47715701     0.9058151     0.3155707   -0.12164747    -0.6722666
## 8     0.31810467    -0.1509692    -0.3506341   -0.14813522     1.3445332
## 9     0.68922680     0.5472633     0.4908878   -0.18050914     0.3361333
## 10    0.00000000     0.9624286     0.7889268    0.38063885    -0.1680666
##    GA_difference MI5_difference One.Percenters_difference BO_difference
## 1      0.3496939      0.7048802                 0.2662789    -0.4672399
## 2      0.0000000     -0.7048802                 0.1775193     0.9344799
## 3      0.0000000      0.2819521                 0.9763559    -0.7787332
## 4      0.0000000     -0.7048802                -0.5325578    -1.0902265
## 5     -1.3987756     -0.9868322                -0.7100770    -0.3114933
## 6     -0.1748470     -0.7048802                 0.3550385    -0.3114933
## 7     -0.5245409      0.2819521                 1.6864329     1.2459732
## 8     -1.3987756     -0.2819521                -2.3965099    -1.7132131
## 9      0.5245409     -0.5639041                 0.5325578    -0.3114933
## 10    -0.1748470     -0.5639041                -0.8875963    -0.1557466
##    TOG_difference K_difference HB_difference D_difference M_difference
## 1       0.3432091  -0.08066657    1.15524392   0.66759213    0.3435361
## 2       0.6864181  -0.59155481    2.20546567   1.00952957   -0.9275476
## 3      -0.3432091   1.42510932    0.00000000   0.86298495    0.9619012
## 4      -0.1716045   0.59155481    1.39154382   1.22120512    0.6527187
## 5       0.1716045  -0.32266626    0.97145512   0.40706837   -0.3778898
## 6       0.0000000  -0.24199970    0.18378881  -0.03256547   -0.2404753
## 7      -0.3432091   0.16133313    0.55136642   0.43963384    0.8588404
## 8      -0.6864181  -0.45711054    0.02625554  -0.26052376    0.5496578
## 9      -0.1716045  -0.53777710    1.68035480   0.71644034   -0.2748289
## 10      0.0000000   0.32266626    0.97145512   0.79785401    0.4809506
##    G_difference B_difference T_difference HO_difference GA1_difference
## 1    -0.4198681    0.3816792   0.60267258    -1.6148566      0.3496939
## 2    -0.2799121   -0.5725188   1.00445430    -0.3341083      0.0000000
## 3    -0.2799121    0.3816792   0.66963620    -0.8352706      0.0000000
## 4    -0.4198681   -1.5267168   0.60267258     0.6125318      0.0000000
## 5    -0.4198681    0.5725188   0.60267258     1.4478024     -1.3987756
## 6    -0.5598242    0.7633584   1.67409050    -1.3364330     -0.1748470
## 7    -0.5598242    0.3816792   1.54016326     1.5034871     -0.5245409
## 8    -0.9796923   -0.7633584   0.06696362     2.3387578     -1.3987756
## 9    -0.4198681   -0.7633584  -1.80801774     0.0000000      0.5245409
## 10    0.1399560   -1.7175564  -0.73659982    -0.8352706     -0.1748470
##    I50_difference CL_difference CG_difference R50_difference FF_difference
## 1      -0.3153089    -0.1054745     0.6397841     0.26238699    -1.3286057
## 2       0.2522471     0.7383218     2.1326136    -0.52477398    -2.1589842
## 3       1.1351120     1.0547454    -1.4928295    -1.92417126     2.1589842
## 4      -0.9459266     0.0000000     1.8127216     0.87462330     0.8303785
## 5       0.1261236    -0.4218982    -0.9596761    -0.61223631     1.3286057
## 6       0.2522471     1.4766436     0.2132614    -0.43731165    -1.3286057
## 7       0.0000000    -0.3164236     0.8530454     0.00000000    -0.3321514
## 8      -0.8198031    -0.5273727     1.0663068     0.08746233     0.3321514
## 9      -0.9459266    -0.1054745     2.1326136     0.87462330    -0.8303785
## 10     -1.1981737    -0.6328472    -0.6397841     1.39939728     1.3286057
##    FA_difference AF_difference SC_difference CCL_difference SCL_difference
## 1      1.1626594    0.25610465    0.36311537     -0.5632730      0.2781803
## 2      2.1592245    0.02885686   -0.28854704      1.1265461      0.1390902
## 3     -2.1592245    1.11820341    0.42795740      0.9387884      0.6954508
## 4     -0.8304710    0.97391910    0.41823110      0.1877577     -0.1390902
## 5     -1.3287536    0.30299705   -0.09402094     -0.5632730     -0.1390902
## 6      1.3287536   -0.03607108   -0.23018921      0.9387884      1.2518115
## 7      0.3321884    0.80799214    0.38256798      0.0000000     -0.4172705
## 8     -0.3321884    0.02524975   -0.31448385     -1.5020614      0.4172705
## 9      0.8304710   -0.38235342   -0.51549415      0.1877577     -0.2781803
## 10    -1.3287536    0.44006715    0.20101030     -1.6898191      0.4172705
##    SI_difference MG_difference TO_difference ITC_difference T5_difference
## 1     0.04356015   -0.09808171    -0.3746883      0.3715625    -0.6493697
## 2     0.08712030   -0.07927152     0.6244804     -0.6192708     0.0000000
## 3     1.00188346    0.24050172     0.9991687     -0.7431250     0.1298739
## 4    -0.65340226   -0.65701307     1.2489609     -1.2385416    -1.1688655
## 5    -0.52272181   -0.19750700    -0.3746883      0.6192708     0.5194958
## 6     0.30492105    0.06583567    -0.2497922      0.3715625     0.3896218
## 7     0.76230263    0.22840945     0.2497922     -0.2477083     0.1298739
## 8    -1.02366354   -0.89348403     0.1248961     -0.2477083    -0.1298739
## 9    -0.32670113   -0.30365021     0.6244804     -0.6192708    -0.5194958
## 10   -0.10890038   -0.48369060     0.6244804     -0.6192708    -0.6493697
##    Round.y Points Margin  prob.win
## 1       R3     80    -15 0.8031403
## 2      R11     88    -13 0.7841533
## 3       R4     79     -7 0.7528645
## 4      R10     77    -28 0.7121611
## 5       R2     79    -16 0.7071859
## 6       R3     87    -16 0.6883663
## 7       R8     45    -21 0.6727448
## 8       R5     56    -46 0.6475927
## 9       R7     67    -23 0.6003894
## 10      R2    117     -1 0.5962056</code></pre>
</div>
