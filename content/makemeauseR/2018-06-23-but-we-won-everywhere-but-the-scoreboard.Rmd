---
title : "But We Won Everywhere but the Scoreboard"
description : "Introduction to logistic regression"
author : "Robert Nguyen"
date : 2018-06-23
tags : ["regression", "fitzRoy","modelling"]

---

Something that gets to many a footy fan, is the feeling that your team has won the game in most areas expect on the scoreboard. 

Thinking about this statement a little bit deeper has the following implication. That there are some areas of the game, that if you win, you tend to win the game. 

We can think about this by putting it into a model. 

The model I will use here, is a logistic regression model with the binary outcome being win/loss. 

The data we will use here is the game differentials of the various game statistics that are available using [fitzRoy](https://github.com/jimmyday12/fitzRoy)

# Step One

Create the dataset we will use for modelling. 

The general idea is its fairly obvious if you score more than the opposition you win. Shocking I know! What we are trying to do here, is come up with a concept of we won other things but not the scoreboard, usually when we win these things we tend to win a game. 




```{r}
library(tidyverse)
fitzRoy::player_stats%>%
    filter(Season>2014 & Season<2018)%>%
    select(-Player)%>%
    group_by(Date,Season, Round, Team, Status, Opposition, Venue, Match_id)%>%
    summarise_all(.funs = sum)%>%
group_by(Match_id)%>%
  arrange(Match_id)%>%
  mutate(diff_cp=c(-diff(CP), diff(CP)))

```

```{r}
fitzRoy::player_stats%>%
         filter(Season>2014 & Season<2018)%>%
         select(-Player,-Date)%>%
         group_by(Season, Round, Team, Status, Opposition, Venue, Match_id)%>%
         summarise_all(.funs = sum)%>%
         group_by(Match_id)%>%
         arrange(Match_id)%>%
         mutate_if(is.numeric, funs(difference=c(-diff(.), diff(.))))

```

```{r}
df<-fitzRoy::player_stats%>%
         filter(Season>2014)%>%
         select(-Player)%>%
         group_by(Date,Season, Round, Team, Status, Opposition, Venue, Match_id)%>%
         summarise_all(.funs = sum)%>%
         group_by(Match_id)%>%
         arrange(Match_id)%>%
         mutate_if(is.numeric, funs(difference=c(-diff(.), diff(.))))

df2<-fitzRoy::match_results
df2<-df2%>%filter(Season>2014)
df3<-select(df2, Date, Round, Home.Team, Home.Points)
df4<-select(df2, Date, Round, Away.Team, Away.Points)
colnames(df3)[3]<-"Team"
colnames(df3)[4]<-"Points"
colnames(df4)[3]<-"Team"
colnames(df4)[4]<-"Points"


df5<-rbind(df4,df3)



df5<-df5 %>%mutate(Team = str_replace(Team, "Brisbane Lions", "Brisbane"))

df5<-df5 %>%mutate(Team = str_replace(Team, "Footscray", "Western Bulldogs"))


df6<-inner_join(df,df5, by=c("Team","Date"))

dataset_columns <- c(1,2,4,6,7,8,44:80,81)
dataset<-df6%>%group_by(Match_id)%>%
  arrange(Match_id)%>%
  mutate(Margin=c(-diff(Points), diff(Points)))%>%
  mutate(Win_loss=if_else(Margin>0,1,0,NULL))%>%
  select(dataset_columns)


```


```{r}
library(aod)
library(ordinal)
library(lme4)
in.sample  <- subset(dataset, Season %in% c(2015:2017))
#in.sample  <- subset(mydata, year ==2008)
out.sample <- subset(dataset, Season == 2018)

in.sample$Win_loss <- factor(in.sample$Win_loss)

out.sample$Win_loss<-factor(out.sample$Win_loss)


temp1<-scale(in.sample[,7:40])
in.sample[,7:40]<-temp1
#attributes(temp1)
temp1.center<-attr(temp1,"scaled:center")
temp1.scale<-attr(temp1,"scaled:scale")

m <- glm(Win_loss ~CP_difference+UP_difference+CM_difference+T_difference, 
         data = in.sample, family =binomial)



newdata   <- out.sample[ , -ncol(out.sample)]


newdata[,7:40]<-scale(newdata[,7:40],center=temp1.center,scale=temp1.scale) 



pre.dict    <- predict(m,newdata=newdata, type="response")
pre.dict.m  <- data.frame(matrix(unlist(pre.dict), nrow= nrow(newdata)))
colnames(pre.dict.m) <- c("prob.win")

newdata.pred  <- cbind.data.frame(newdata, pre.dict.m)
newdata.pred%>%
  filter(Margin<0)%>%
  arrange(desc(prob.win))%>%
  top_n(10)

```


